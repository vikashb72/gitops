{{- range $key, $value := .Values.gateways }}
{{- if not .disabled }}
{{- if $value.VirtualServices }}
{{- range $value.VirtualServices }}
{{- if .DestinationRule }}
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: {{ .name | replace "virtual-service" "destination-rule" }}
  namespace: {{ default "istio-system" $.Values.schema.istioNamespace }}
spec:
  host: {{ .DestinationRule.host }}
  trafficPolicy:
{{- if .DestinationRule.tls }}
    tls:
      mode: SIMPLE
{{- end }}
{{- if .DestinationRule.maxConnections }}
    connectionPool:
      tcp:
        maxConnections: {{ .DestinationRule.maxConnections }}
        connectTimeout: 5s
        tcpKeepalive:
          time: 7200s
          interval: 75s
      http:
        http2MaxRequests: 5
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 2
        useClientProtocol: true
        maxConcurrentStreams: 2
{{- end }}
---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
