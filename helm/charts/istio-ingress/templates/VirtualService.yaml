{{- range $key, $value := .Values.gateways }}
{{- if not .disabled }}
{{- if $value.VirtualServices }}
{{- range $VirtualService:= $value.VirtualServices }}
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: {{ $VirtualService.name }}
  namespace: {{ $.Release.Namespace }}
spec:
  #timeout: 5s
{{- with $VirtualService.hosts }}
  hosts:
    {{- toYaml . | nindent 4 }}
{{- end }}
  gateways:
    - {{ $key }}
{{- with $VirtualService.tcp }}
  tcp:
   {{- toYaml . | nindent 4 }}
{{- end }}
{{- with $VirtualService.http }}
  http:
{{- if and $VirtualService.CustomAuthorizationPolicy
       (eq $VirtualService.CustomAuthorizationPolicy.meshProvider "authentik")
}}
    - match:
        - uri:
            prefix: /outpost.goauthentik.io
      route:
        - destination:
            host: authentik-server.authentik.svc.cluster.local
            port:
              number: 80
{{- end }}
    {{- toYaml . | nindent 4 }}
{{- end }}
{{- if and $VirtualService.CustomAuthorizationPolicy
       (eq $VirtualService.CustomAuthorizationPolicy.meshProvider "oauth-proxy")
}}
        headers:
          request:
            set:
              Authorization: 'Bearer %REQ(x-auth-request-access-token)%'
{{- end }}
{{- with $VirtualService.tls }}
  tls:
    {{- toYaml . | nindent 4 }}
{{- end }}
---
{{- end }}
{{- end }}
{{- end }}
{{- end }}
