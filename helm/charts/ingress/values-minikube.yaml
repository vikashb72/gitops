schema:
  env: minikube

certificates:
  - name: httpbin-gateway-tls
    host: httpbin.minikube.where-ever.net
  - name: echoserver-gateway-tls
    host: echoserver.minikube.where-ever.net
  - name: argocd-gateway-tls
    host: argocd.minikube.where-ever.net
    dnsNames:
      - argocd.minikube.where-ever.net
      - argocd-gui.minikube.where-ever.net
  - name: prometheus-gateway-tls
    host: prometheus.minikube.where-ever.net

gateways:
  app-gateway:
    gateway: istio
    LoadBalancerIP: "192.168.49.251"
    listeners:
      - name: httpbin-https
        hostname: "httpbin.minikube.where-ever.net"
        port: 443
        protocol: HTTPS
        tls:
          mode: Terminate
          certificateRefs:
            - name: httpbin-gateway-tls
        allowedRoutes:
          namespaces:
            from: All
      - name: echoserver-https
        hostname: "echoserver.minikube.where-ever.net"
        port: 443
        protocol: HTTPS
        tls:
          mode: Terminate
          certificateRefs:
            - name: echoserver-gateway-tls
        allowedRoutes:
          namespaces:
            from: All
    httproutes:
      - name: httpbin
        namespace: httpbin
        hostnames: '["httpbin.minikube.where-ever.net"]'
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /get
              - path:
                  type: PathPrefix
                  value: /headers
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  add:
                  - name: Added-Header
                    value: added-value
            backendRefs:
              - name: httpbin
                port: 8000
      - name: echoserver
        namespace: echoserver
        hostnames: '["echoserver.minikube.where-ever.net"]'
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: echoserver
                port: 80
  infra-gateway:
    LoadBalancerIP: "192.168.49.252"
    gateway: istio
    listeners:
      - name: argocd-https
        hostname: "argocd.minikube.where-ever.net"
        #protocol: HTTPS
        protocol: TLS
        port: 443
        tls:
          #mode: Terminate
          mode: Passthrough
          certificateRefs:
            - kind: Secret
              name: argocd-gateway-tls
          #options:
          #  gateway.istio.io/tls-terminate-mode: MUTUAL
        allowedRoutes:
          namespaces:
            from: All
      - name: prometheus-https
        hostname: "prometheus.minikube.where-ever.net"
        protocol: HTTPS
        port: 443
        tls:
          mode: Terminate
          certificateRefs:
            - kind: Secret
              name: prometheus-gateway-tls
        allowedRoutes:
          namespaces:
            from: All
    httproutes:
      - name: argocd-https
        namespace: argocd
        #sectionName: argocd-https
        hostnames: '["argocd.minikube.where-ever.net"]'
        rules:
          - backendRefs:
              - name: argocd-server
                port: 443
                group: ''
                kind: Service
                weight: 1
            matches:
              - path:
                  type: PathPrefix
                  value: /
      - name: prometheus-https
        namespace: monitoring
        hostnames: '["prometheus.minikube.where-ever.net"]'
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: kube-prometheus-stack-prometheus
                port: 9090
