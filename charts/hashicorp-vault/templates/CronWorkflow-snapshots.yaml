---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: raft-snapshot-cron
  namespace: argocd
spec:
  serviceAccountName: argocd-application-controller
  schedule: "*/2 * * * *"
  concurrencyPolicy: "Replace"
  startingDeadlineSeconds: 0
  successfulJobsHistoryLimit: 1
  workflowSpec:
    entrypoint: snapshot
    templates:
      - name: snapshot
        container:
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              apk add --no-cache --update curl jq
              # Get a snapshot
              export VAULT_ADDR="https://vault-active.vault.svc.cluster.local:8200"
              mkdir -p /tmp/work && cd /tmp/work
              set -vx 
              curl -vL -H "X-Vault-Token: ${VAULT_TOKEN}" \
                  ${VAULT_ADDR}/v1/sys/storage/raft/snapshot \
                  -o raft.snapshot.$(date +"%s").tgz
              ls -l 
              #curl -sLO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl && \
              #curl -sLO http://192.168.0.5/linux/kubectl && \
              #chmod +x kubectl && mv kubectl /usr/local/bin/kubectl
          env:
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: raft-snapshot-token
                  key: token
