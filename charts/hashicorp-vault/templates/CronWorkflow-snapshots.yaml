---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: raft-snapshot-cron
  namespace: argocd
spec:
  serviceAccountName: argocd-application-controller
  schedule: "*/2 * * * *"
  concurrencyPolicy: "Replace"
  startingDeadlineSeconds: 0
  successfulJobsHistoryLimit: 1
  workflowSpec:
    entrypoint: snapshot
    templates:
      - name: snapshot
        container:
          image: alpine:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -vx
              id
              cd /tmp/
              apk add --no-cache --update curl jq
              # Install kubectl
              #curl -sLO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl && \
              #curl -sLO http://192.168.0.5/linux/kubectl && \
              #chmod +x kubectl && mv kubectl /usr/local/bin/kubectl
              curl -sLO http://192.168.0.5/linux/vault && \
              chmod +x vault
              ./vault login ${VAULT_TOKEN}
              ./vault operator raft snapshot save test
              # Get 
              curl -vL -X PUT -H  "X-Vault-Token: ${VAULT_TOKEN}" \
                  ${VAULT_ADDR}/v1/sys/storage/raft/snapshot -o test
              cat /var/run/secrets/kubernetes.io/serviceaccount/token \
                 | cut -f2 -d. 
          env:
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: argo-boostrap-eso-vault
                  key: token
            - name: VAULT_ADDR
              valueFrom:
                secretKeyRef:
                  name: argo-boostrap-eso-vault
                  key: addr
            - name: SEAL_PATH
              valueFrom:
                secretKeyRef:
                  name: argo-boostrap-eso-vault
                  key: path
